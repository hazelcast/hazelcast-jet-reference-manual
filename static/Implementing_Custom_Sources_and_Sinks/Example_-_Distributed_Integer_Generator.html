<!DOCTYPE html>
<!--[if lt IE 7]>       <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>          <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>          <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <title>Example - Distributed Integer Generator - Hazelcast Jet Reference Manual</title>
    <meta name="description" content="Hazelcast Jet Reference Manual" />
    <meta name="author" content="Hazelcast">
    <meta charset="UTF-8">
    <link rel="icon" href="../themes/daux/img/favicon.png" type="image/x-icon">
    <!-- Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font -->
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
    <!-- CSS -->
    <link href='../themes/daux/css/theme-blue.min.css' rel='stylesheet' type='text/css'>
            <!-- Tipue Search -->
        <link href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class="">
    
<header class="Navbar hidden-print">
    <div>
      <div class="sitebar"></div>
        <div>  
          <div style="float:left">
            <a href="http://jet.hazelcast.org/"><img src="logo.png" style="padding-bottom:8px;"/></a>
          </div>
          <div>
            <a class="Navbar__branda" href="../index.html">Reference Manual <span style="font-size:14px">for release 0.3.1</span></a>
          </div>
        </div>
    <div class="Search">
        <svg class="Search__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451 451"><path d="M447.05 428l-109.6-109.6c29.4-33.8 47.2-77.9 47.2-126.1C384.65 86.2 298.35 0 192.35 0 86.25 0 .05 86.3.05 192.3s86.3 192.3 192.3 192.3c48.2 0 92.3-17.8 126.1-47.2L428.05 447c2.6 2.6 6.1 4 9.5 4s6.9-1.3 9.5-4c5.2-5.2 5.2-13.8 0-19zM26.95 192.3c0-91.2 74.2-165.3 165.3-165.3 91.2 0 165.3 74.2 165.3 165.3s-74.1 165.4-165.3 165.4c-91.1 0-165.3-74.2-165.3-165.4z"/></svg>
        <input type="search" id="tipue_search_input" class="Search__field" placeholder="Search..." autocomplete="on" results=25 autosave=text_search>
    </div>


</div></header>
<div class="Columns content">
    <aside class="Columns__left Collapsible">
        <div class="Collapsible__container">
            <button type="button" class="Button Collapsible__trigger">
                <span class="Collapsible__trigger--bar"></span>
                <span class="Collapsible__trigger--bar"></span>
                <span class="Collapsible__trigger--bar"></span>
            </button>
        </div>

        <div class="Collapsible__content">
            <!-- Navigation -->
            <ul class='Nav'><li class='Nav__item '><a href="../Preface.html">Preface</a></li><li class='Nav__item  has-children'><a href="../Introduction/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Introduction</a><ul class='Nav'><li class='Nav__item '><a href="../Introduction/Data_Processing_Model.html">Data Processing Model</a></li><li class='Nav__item '><a href="../Introduction/Clustering_and_Discovery.html">Clustering and Discovery</a></li><li class='Nav__item '><a href="../Introduction/Members_and_Clients.html">Members and Clients</a></li><li class='Nav__item '><a href="../Introduction/Relationship_with_Hazelcast_IMDG.html">Relationship with Hazelcast IMDG</a></li><li class='Nav__item '><a href="../Introduction/Fault_Detection.html">Fault Detection</a></li><li class='Nav__item '><a href="../Introduction/Elasticity.html">Elasticity</a></li></ul></li><li class='Nav__item '><a href="../Getting_Started.html">Getting Started</a></li><li class='Nav__item  has-children'><a href="../Hazelcast_Jet_101_-Word_Counting_Batch_Job/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Hazelcast Jet 101 -Word Counting Batch Job</a><ul class='Nav'><li class='Nav__item '><a href="../Hazelcast_Jet_101_-Word_Counting_Batch_Job/Modeling_Word_Count_in_terms_of_a_DAG.html">Modeling Word Count in terms of a DAG</a></li><li class='Nav__item '><a href="../Hazelcast_Jet_101_-Word_Counting_Batch_Job/Implementing_And_Running_the_DAG.html">Implementing And Running the DAG</a></li></ul></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Understanding Jet Architecture and API</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/DAG.html">DAG</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Job.html">Job</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Vertex.html">Vertex</a></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/Processor/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Processor</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Processor/Cooperative_Multithreading.html">Cooperative Multithreading</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Processor/Outbox.html">Outbox</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Processor/Data-Processing_Callbacks.html">Data-Processing Callbacks</a></li></ul></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Creating_and_Initializing_Jobs.html">Creating and Initializing Jobs</a></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/AbstractProcessor.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Convenience API to Implement a Processor</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/AbstractProcessor.html">AbstractProcessor</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/Traverser.html">Traverser</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/Simple_Example.html">Simple Example</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/Processor_Utility_Class.html">Processor Utility Class</a></li></ul></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/Edge/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Edge</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Priority.html">Priority</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Local_and_Distributed_Edges.html">Local and Distributed Edges</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Forwarding_Patterns.html">Forwarding Patterns</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Buffered_Edges.html">Buffered Edges</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Tuning_Edges.html">Tuning Edges</a></li></ul></li></ul></li><li class='Nav__item  has-children'><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Advanced Tutorial - Inverted TF-IDF Index</a><ul class='Nav'><li class='Nav__item '><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Building_Inverted_Index_with_Java_Streams.html">Building Inverted Index with Java Streams</a></li><li class='Nav__item '><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Translating_to_Jet_DAG/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Translating to Jet DAG</a><ul class='Nav'></ul></li></ul></li><li class='Nav__item  has-children'><a href="../Understanding_Configuration/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Understanding Configuration</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Configuration/Configuring_Programatically.html">Configuring Programatically</a></li><li class='Nav__item '><a href="../Understanding_Configuration/Configuring_Declaratively.html">Configuring Declaratively</a></li><li class='Nav__item '><a href="../Understanding_Configuration/Configuring_Underlying_Hazelcast_Instance.html">Configuring Underlying Hazelcast Instance</a></li></ul></li><li class='Nav__item Nav__item--open has-children'><a href="../Implementing_Custom_Sources_and_Sinks/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Implementing Custom Sources and Sinks</a><ul class='Nav'><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Sources.html">Sources</a></li><li class='Nav__item Nav__item--active'><a href="../Implementing_Custom_Sources_and_Sinks/Example_-_Distributed_Integer_Generator.html">Example - Distributed Integer Generator</a></li><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Sinks.html">Sinks</a></li><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Example_-_File_Writer.html">Example - File Writer</a></li></ul></li><li class='Nav__item  has-children'><a href="../java-util-stream_Support_for_Hazelcast_IMDG/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>java-util-stream Support for Hazelcast IMDG</a><ul class='Nav'><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Simple_Example.html">Simple Example</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Serializable_Lambda_Functions.html">Serializable Lambda Functions</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Distributed_Collectors.html">Distributed Collectors</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Word_Count.html">Word Count</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Implementation_Notes.html">Implementation Notes</a></li></ul></li><li class='Nav__item  has-children'><a href="../Additional_Modules/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Additional Modules</a><ul class='Nav'><li class='Nav__item  has-children'><a href="../Additional_Modules/hazelcast-jet-hadoop/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>hazelcast-jet-hadoop</a><ul class='Nav'><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-hadoop/ReadHdfsP.html">ReadHdfsP</a></li><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-hadoop/WriteHdfsP.html">WriteHdfsP</a></li><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-hadoop/Serialization_of_Writables.html">Serialization of Writables</a></li></ul></li><li class='Nav__item  has-children'><a href="../Additional_Modules/hazelcast-jet-kafka/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>hazelcast-jet-kafka</a><ul class='Nav'><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-kafka/StreamKafkaP.html">StreamKafkaP</a></li><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-kafka/WriteKafkaP.html">WriteKafkaP</a></li></ul></li></ul></li><li class='Nav__item  has-children'><a href="../Best_Practices/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Best Practices</a><ul class='Nav'><li class='Nav__item '><a href="../Best_Practices/Jobs.html">Jobs</a></li></ul></li></ul>

            <div class="Links">
                                    <hr/>
                                            <a href="https://github.com/hazelcast/hazelcast-jet" target="_blank">GitHub Repo</a>
                        <br />
                                            <a href="https://github.com/hazelcast/hazelcast-jet/issues/new" target="_blank">Send Us a Fix</a>
                        <br />
                                            <a href="http://jet.hazelcast.org/documentation/" target="_blank">Go to Jet documentation</a>
                        <br />
                                    
                                    <div class="CodeToggler">
                        <hr/>
                                                    <a class="CodeToggler__button CodeToggler__button--main" href="#">Show Code Blocks Inline</a><br>
                                            </div>
                
                            </div>
        </div>
    </aside>
    <div class="Columns__right ">
        <div class="Columns__right__content">
            <div class="doc_content">
                <article class="Page">

    <div class="Page__header">
        <h1><a href="../Implementing_Custom_Sources_and_Sinks/index.html">Implementing Custom Sources and Sinks</a> <svg class="Page__header--separator" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M360.73 229.075l-225.1-225.1c-5.3-5.3-13.8-5.3-19.1 0s-5.3 13.8 0 19.1l215.5 215.5-215.5 215.5c-5.3 5.3-5.3 13.8 0 19.1 2.6 2.6 6.1 4 9.5 4 3.4 0 6.9-1.3 9.5-4l225.1-225.1c5.3-5.2 5.3-13.8.1-19z"/></svg> <a href="../Implementing_Custom_Sources_and_Sinks/Example_-_Distributed_Integer_Generator.html">Example - Distributed Integer Generator</a></h1>
                    </div>


    <div class="s-content">
        <p>Let's say we want to write a simple source that will generate numbers from
0 to 1,000,000 (exclusive). It is trivial to write a single <code>Processor</code>
which can do this using <code>java.util.stream</code> and <a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/Traverser.html"><code>Traverser</code></a>.</p>
<pre><code class="language-java">class GenerateNumbersP extends AbstractProcessor {

    private final Traverser&lt;Integer&gt; traverser;

    GenerateNumbersP(int upperBound) {
        traverser = Traversers.traverseStream(IntStream.range(0, upperBound).boxed());
    }

    @Override
    public boolean complete() {
        return emitFromTraverser(traverser);
    }
}
</code></pre>
<p>We will also add a simple logging processor so we can see what values
are generated:</p>
<pre><code class="language-java">class LogInputP extends AbstractProcessor {

    LogInputP() {
        setCooperative(false);
    }

    @Override
    protected boolean tryProcess(int ordinal, @Nonnull Object item) {
        System.out.println(&quot;Received number: &quot; + item);
        emit(item);
        return true;
    }
}
</code></pre>
<p>Now we can build our DAG and execute it:</p>
<pre><code class="language-java">JetInstance jet = Jet.newJetInstance();

int upperBound = 10;
DAG dag = new DAG();
Vertex generateNumbers = dag.newVertex(&quot;generate-numbers&quot;,
        () -&gt; new GenerateNumbersP(upperBound));
Vertex logInput = dag.newVertex(&quot;log-input&quot;, LogInputP::new);
dag.edge(Edge.between(generateNumbers, logInput));

try {
    jet.newJob(dag).execute().get();
} finally {
    Jet.shutdownAll();
}
</code></pre>
<p>When you run this code, you will see the output as below:</p>
<pre><code>Received number: 4
Received number: 0
Received number: 3
Received number: 2
Received number: 2
Received number: 2
</code></pre>
<p>Since we are using the default parallelism setting on this vertex,
several instances of the source processor were created, all of which
generated the same sequence of values. Generally we'll want the ability
to parallelize the source vertex, so we have to make each processor emit
only a slice of the total data set.</p>
<p>So far we've used the simplest approach to creating processors: a
<code>Supplier&lt;Processor&gt;</code> function that keeps returning equal instances of
processors. Now we'll step up to Jet's custom interface that gives us
the ability to provide a list of separately configured processors:
<code>ProcessorSupplier</code> and its method <code>get(int processorCount)</code>.</p>
<p>First we must decide on a partitioning policy: what subset will each
processor emit. In our simple example we can use a simple policy: we'll
label each processor with its index in the list and have it emit only
those numbers <code>n</code> that satisfy <code>n % processorCount == processorIndex</code>.
Let's write a new constructor for our processor which implements this
partitioning logic:</p>
<pre><code class="language-java">GenerateNumbersP(int upperBound, int processorCount, int processorIndex) {
    traverser = Traversers.traverseStream(
            IntStream.range(0, upperBound)
                     .filter(n -&gt; n % processorCount == processorIndex)
                     .boxed());
}
</code></pre>
<p>Given this preparation, implementing <code>ProcessorSupplier</code> is trivial:</p>
<pre><code class="language-java">class GenerateNumbersPSupplier implements ProcessorSupplier {

    private final int upperBound;

    GenerateNumbersPSupplier(int upperBound) {
        this.upperBound = upperBound;
    }

    @Override @Nonnull
    public List&lt;? extends Processor&gt; get(int processorCount) {
        return IntStream.range(0, processorCount)
                .mapToObj(index -&gt; new GenerateNumbersP(upperBound, processorCount, index))
                .collect(Collectors.toList());
    }
}
</code></pre>
<p>Let's use the custom processor supplier in our DAG-building code:</p>
<pre><code class="language-java">DAG dag = new DAG();
Vertex generateNumbers = dag.newVertex(&quot;generate-numbers&quot;,
        new GenerateNumbersPSupplier(10));
Vertex logInput = dag.newVertex(&quot;log-input&quot;, LogInputP::new);
dag.edge(Edge.between(generateNumbers, logInput));
</code></pre>
<p>Now we can re-run our example and see that indeed each number occurs
only once. However, note that we are still working with a single-member
Jet cluster; let's see what happens when we add another member:</p>
<pre><code class="language-java">JetInstance jet = Jet.newJetInstance();
Jet.newJetInstance();

DAG dag = new DAG();
...
</code></pre>
<hr />
<p>Running after this change we'll see that both members are generating the
same set of numbers. This is because <code>ProcessorSupplier</code> is instantiated
independently for each member and asked for the same number of
processors, resulting in identical processors on all members. We have to
solve the same problem as we just did, but at the higher level of
cluster-wide parallelism. For that we'll need the
<code>ProcessorMetaSupplier</code>: an interface which acts as a factory of
<code>ProcessorSupplier</code>s, one for each cluster member. Under the hood it is
actually always the meta-supplier that's created by the DAG-building
code; the above examples are just implicit about it for the sake of
convenience. They result in a simple meta-supplier that reuses the
provided suppliers everywhere.</p>
<p>The meta-supplier is a bit trickier to implement because its method
takes a list of Jet member addresses instead of a simple count, and the
return value is a function from address to <code>ProcessorSupplier</code>. In our
case we'll treat the address as just an opaque ID and we'll build a map
from address to a properly configured <code>ProcessorSupplier</code>. Then we can
simply return <code>map::get</code> as our function.</p>
<pre><code class="language-java">class GenerateNumbersPMetaSupplier implements ProcessorMetaSupplier {

    private final int upperBound;

    private transient int totalParallelism;
    private transient int localParallelism;

    GenerateNumbersPMetaSupplier(int upperBound) {
        this.upperBound = upperBound;
    }

    @Override
    public void init(@Nonnull Context context) {
        totalParallelism = context.totalParallelism();
        localParallelism = context.localParallelism();
    }

    @Override @Nonnull
    public Function&lt;Address, ProcessorSupplier&gt; get(@Nonnull List&lt;Address&gt; addresses) {
        Map&lt;Address, ProcessorSupplier&gt; map = new HashMap&lt;&gt;();
        for (int i = 0; i &lt; addresses.size(); i++) {
            // We'll calculate the global index of each processor in the cluster:
            int globalIndexBase = localParallelism * i;
            // Capture the value of the transient field for the lambdas below:
            int divisor = totalParallelism;
            // processorCount will be equal to localParallelism:
            ProcessorSupplier supplier = processorCount -&gt;
                    range(globalIndexBase, globalIndexBase + processorCount)
                            .mapToObj(globalIndex -&gt;
                                new GenerateNumbersP(upperBound, divisor, globalIndex)
                            ).collect(toList());
            map.put(addresses.get(i), supplier);
        }
        return map::get;
    }

}
</code></pre>
<p>We change our DAG-building code to use the meta-supplier:</p>
<pre><code class="language-java">DAG dag = new DAG();
Vertex generateNumbers = dag.newVertex(&quot;generate-numbers&quot;,
        new GenerateNumbersPMetaSupplier(upperBound));
Vertex logInput = dag.newVertex(&quot;log-input&quot;, LogInputP::new);
dag.edge(Edge.between(generateNumbers, logInput));
</code></pre>
<p>After re-running with two Jet members, we should once again see each
number generated just once.</p>
    </div>

        <nav>
        <ul class="Pager">
            <li class=Pager--prev><a href="../Implementing_Custom_Sources_and_Sinks/Sources.html">Previous</a></li>            <li class=Pager--next><a href="../Implementing_Custom_Sources_and_Sinks/Sinks.html">Next</a></li>        </ul>
    </nav>
    </article>

            </div>
        </div>
    </div>
</div>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-12653604-10', '');
    ga('send', 'pageview');
</script>

    <!-- jQuery -->
    <script src="../themes/daux/js/jquery-1.11.3.min.js"></script>

    <!-- hightlight.js -->
    <script src="../themes/daux/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- JS -->
    
    <script src="../themes/daux/js/daux.js"></script>

            <!-- Tipue Search -->
        <script type="text/javascript" src="../tipuesearch/tipuesearch.js"></script>

        <script>
            window.onunload = function(){}; // force $(document).ready to be called on back/forward navigation in firefox
            $(function() {
                tipuesearch({
                    'base_url': '../'
                });
            });
        </script>
    
</body>
</html>
