<!DOCTYPE html>
<!--[if lt IE 7]>       <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>          <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>          <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <title>Building Inverted Index with Java Streams - Hazelcast Jet Reference Manual</title>
    <meta name="description" content="Hazelcast Jet Reference Manual" />
    <meta name="author" content="Hazelcast">
    <meta charset="UTF-8">
    <link rel="icon" href="../themes/daux/img/favicon.png" type="image/x-icon">
    <!-- Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font -->
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
    <!-- CSS -->
    <link href='../themes/daux/css/theme-blue.min.css' rel='stylesheet' type='text/css'>
            <!-- Tipue Search -->
        <link href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class="">
    
<header class="Navbar hidden-print">
    <div>
      <div class="sitebar"></div>
        <div>  
          <div style="float:left">
            <a href="http://jet.hazelcast.org/"><img src="logo.png" style="padding-bottom:8px;"/></a>
          </div>
          <div>
            <a class="Navbar__branda" href="../index.html">Reference Manual <span style="font-size:14px">for release 0.3.1</span></a>
          </div>
        </div>
    <div class="Search">
        <svg class="Search__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451 451"><path d="M447.05 428l-109.6-109.6c29.4-33.8 47.2-77.9 47.2-126.1C384.65 86.2 298.35 0 192.35 0 86.25 0 .05 86.3.05 192.3s86.3 192.3 192.3 192.3c48.2 0 92.3-17.8 126.1-47.2L428.05 447c2.6 2.6 6.1 4 9.5 4s6.9-1.3 9.5-4c5.2-5.2 5.2-13.8 0-19zM26.95 192.3c0-91.2 74.2-165.3 165.3-165.3 91.2 0 165.3 74.2 165.3 165.3s-74.1 165.4-165.3 165.4c-91.1 0-165.3-74.2-165.3-165.4z"/></svg>
        <input type="search" id="tipue_search_input" class="Search__field" placeholder="Search..." autocomplete="on" results=25 autosave=text_search>
    </div>


</div></header>
<div class="Columns content">
    <aside class="Columns__left Collapsible">
        <div class="Collapsible__container">
            <button type="button" class="Button Collapsible__trigger">
                <span class="Collapsible__trigger--bar"></span>
                <span class="Collapsible__trigger--bar"></span>
                <span class="Collapsible__trigger--bar"></span>
            </button>
        </div>

        <div class="Collapsible__content">
            <!-- Navigation -->
            <ul class='Nav'><li class='Nav__item '><a href="../Preface.html">Preface</a></li><li class='Nav__item  has-children'><a href="../Introduction/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Introduction</a><ul class='Nav'><li class='Nav__item '><a href="../Introduction/Data_Processing_Model.html">Data Processing Model</a></li><li class='Nav__item '><a href="../Introduction/Clustering_and_Discovery.html">Clustering and Discovery</a></li><li class='Nav__item '><a href="../Introduction/Members_and_Clients.html">Members and Clients</a></li><li class='Nav__item '><a href="../Introduction/Relationship_with_Hazelcast_IMDG.html">Relationship with Hazelcast IMDG</a></li><li class='Nav__item '><a href="../Introduction/Fault_Detection.html">Fault Detection</a></li><li class='Nav__item '><a href="../Introduction/Elasticity.html">Elasticity</a></li></ul></li><li class='Nav__item '><a href="../Getting_Started.html">Getting Started</a></li><li class='Nav__item  has-children'><a href="../Hazelcast_Jet_101_-Word_Counting_Batch_Job/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Hazelcast Jet 101 -Word Counting Batch Job</a><ul class='Nav'><li class='Nav__item '><a href="../Hazelcast_Jet_101_-Word_Counting_Batch_Job/Modeling_Word_Count_in_terms_of_a_DAG.html">Modeling Word Count in terms of a DAG</a></li><li class='Nav__item '><a href="../Hazelcast_Jet_101_-Word_Counting_Batch_Job/Implementing_and_Running_the_DAG.html">Implementing and Running the DAG</a></li></ul></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Understanding Jet Architecture and API</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/DAG.html">DAG</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Job.html">Job</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Vertex.html">Vertex</a></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/Processor/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Processor</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Processor/Cooperative_Multithreading.html">Cooperative Multithreading</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Processor/Outbox.html">Outbox</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Processor/Data-Processing_Callbacks.html">Data-Processing Callbacks</a></li></ul></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Creating_and_Initializing_Jobs.html">Creating and Initializing Jobs</a></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/AbstractProcessor.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Convenience API to Implement a Processor</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/AbstractProcessor.html">AbstractProcessor</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/Traverser.html">Traverser</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Convenience_API_to_Implement_a_Processor/Processor_Utility_Class.html">Processor Utility Class</a></li></ul></li><li class='Nav__item  has-children'><a href="../Understanding_Jet_Architecture_and_API/Edge/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Edge</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Priority.html">Priority</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Local_and_Distributed_Edges.html">Local and Distributed Edges</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Forwarding_Patterns.html">Forwarding Patterns</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Buffered_Edges.html">Buffered Edges</a></li><li class='Nav__item '><a href="../Understanding_Jet_Architecture_and_API/Edge/Tuning_Edges.html">Tuning Edges</a></li></ul></li></ul></li><li class='Nav__item Nav__item--open has-children'><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Advanced Tutorial - Inverted TF-IDF Index</a><ul class='Nav'><li class='Nav__item Nav__item--active'><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Building_Inverted_Index_with_Java_Streams.html">Building Inverted Index with Java Streams</a></li><li class='Nav__item '><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Translating_to_Jet_DAG.html">Translating to Jet DAG</a></li><li class='Nav__item '><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Implementation Code.html">Implementation Code</a></li></ul></li><li class='Nav__item  has-children'><a href="../Understanding_Configuration/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Understanding Configuration</a><ul class='Nav'><li class='Nav__item '><a href="../Understanding_Configuration/Configuring_Programatically.html">Configuring Programatically</a></li><li class='Nav__item '><a href="../Understanding_Configuration/Configuring_Declaratively.html">Configuring Declaratively</a></li><li class='Nav__item '><a href="../Understanding_Configuration/Configuring_Underlying_Hazelcast_Instance.html">Configuring Underlying Hazelcast Instance</a></li></ul></li><li class='Nav__item  has-children'><a href="../Implementing_Custom_Sources_and_Sinks/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Implementing Custom Sources and Sinks</a><ul class='Nav'><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Sources.html">Sources</a></li><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Example_-_Distributed_Integer_Generator.html">Example - Distributed Integer Generator</a></li><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Sinks.html">Sinks</a></li><li class='Nav__item '><a href="../Implementing_Custom_Sources_and_Sinks/Example_-_File_Writer.html">Example - File Writer</a></li></ul></li><li class='Nav__item  has-children'><a href="../java-util-stream_Support_for_Hazelcast_IMDG/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>java-util-stream Support for Hazelcast IMDG</a><ul class='Nav'><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Simple_Example.html">Simple Example</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Serializable_Lambda_Functions.html">Serializable Lambda Functions</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Distributed_Collectors.html">Distributed Collectors</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Word_Count.html">Word Count</a></li><li class='Nav__item '><a href="../java-util-stream_Support_for_Hazelcast_IMDG/Implementation_Notes.html">Implementation Notes</a></li></ul></li><li class='Nav__item  has-children'><a href="../Additional_Modules/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Additional Modules</a><ul class='Nav'><li class='Nav__item  has-children'><a href="../Additional_Modules/hazelcast-jet-hadoop/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>hazelcast-jet-hadoop</a><ul class='Nav'><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-hadoop/ReadHdfsP.html">ReadHdfsP</a></li><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-hadoop/WriteHdfsP.html">WriteHdfsP</a></li><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-hadoop/Serialization_of_Writables.html">Serialization of Writables</a></li></ul></li><li class='Nav__item  has-children'><a href="../Additional_Modules/hazelcast-jet-kafka/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>hazelcast-jet-kafka</a><ul class='Nav'><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-kafka/StreamKafkaP.html">StreamKafkaP</a></li><li class='Nav__item '><a href="../Additional_Modules/hazelcast-jet-kafka/WriteKafkaP.html">WriteKafkaP</a></li></ul></li></ul></li><li class='Nav__item  has-children'><a href="../Best_Practices/index.html" class="folder"><i class="Nav__arrow">&nbsp;</i>Best Practices</a><ul class='Nav'><li class='Nav__item '><a href="../Best_Practices/Jobs.html">Jobs</a></li></ul></li></ul>

            <div class="Links">
                                    <hr/>
                                            <a href="https://github.com/hazelcast/hazelcast-jet" target="_blank">GitHub Repo</a>
                        <br />
                                            <a href="https://github.com/hazelcast/hazelcast-jet/issues/new" target="_blank">Send Us a Fix</a>
                        <br />
                                            <a href="http://jet.hazelcast.org/documentation/" target="_blank">Go to Jet documentation</a>
                        <br />
                                    
                                    <div class="CodeToggler">
                        <hr/>
                                                    <a class="CodeToggler__button CodeToggler__button--main" href="#">Show Code Blocks Inline</a><br>
                                            </div>
                
                            </div>
        </div>
    </aside>
    <div class="Columns__right ">
        <div class="Columns__right__content">
            <div class="doc_content">
                <article class="Page">

    <div class="Page__header">
        <h1><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/index.html">Advanced Tutorial - Inverted TF-IDF Index</a> <svg class="Page__header--separator" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M360.73 229.075l-225.1-225.1c-5.3-5.3-13.8-5.3-19.1 0s-5.3 13.8 0 19.1l215.5 215.5-215.5 215.5c-5.3 5.3-5.3 13.8 0 19.1 2.6 2.6 6.1 4 9.5 4 3.4 0 6.9-1.3 9.5-4l225.1-225.1c5.3-5.2 5.3-13.8.1-19z"/></svg> <a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Building_Inverted_Index_with_Java_Streams.html">Building Inverted Index with Java Streams</a></h1>
                    </div>


    <div class="s-content">
        <p>To warm us up, let's see what it takes to build the inverted index with
just thread parallelism and without the ability to scale out across
many machines. It is expressible in Java Streams API without too much
work. The full code is <a href="https://github.com/hazelcast/hazelcast-jet-code-samples/blob/master/batch/tf-idf/src/main/java/TfIdfJdkStreams.java" class="external">here</a>.</p>
<p>We'll start by preparing a <code>Stream&lt;Entry&lt;Long, String&gt;&gt; docWords</code>: a stream of all the words found in all the documents. We use <code>Map.Entry</code> as a holder of a pair of values (a 2-tuple) and here we have a pair of <code>Long docId</code> and <code>String word</code>:</p>
<pre><code class="language-java">Stream&lt;Entry&lt;Long, String&gt;&gt; docWords = docId2Name
        .entrySet()
        .parallelStream()
        .flatMap(TfIdfJdkStreams::docLines)
        .flatMap(this::tokenize);
</code></pre>
<p>We know the number of all documents so we can compute <code>double logDocCount</code>, the logarithm of the document count:</p>
<pre><code class="language-java">double logDocCount = Math.log(docId2Name.size());
</code></pre>
<p>Calculating TF is very easy, just count the number of occurrences of
each distinct pair and save the result in a <code>Map&lt;Entry&lt;Long, String&gt;, Long&gt;</code>:</p>
<pre><code class="language-java">// TF map: (docId, word) -&gt; count
final Map&lt;Entry&lt;Long, String&gt;, Long&gt; tfMap = docWords
        .parallel()
        .collect(groupingBy(identity(), counting()));
</code></pre>
<p>And now we build the inverted index. We start from <code>tfMap</code>, group by
word, and the list under each word already matches our final product:
the list of all the documents containing the word. We finish off by
applying a transformation to the list: currently it's just the raw
entries from the <code>tf</code> map, but we need pairs <code>(docId, tfIDfScore)</code>.</p>
<pre><code class="language-java">invertedIndex = tfMap
    .entrySet() // set of ((docId, word), count)
    .parallelStream()
    .collect(groupingBy(
        e -&gt; e.getKey().getValue(),
        collectingAndThen(
            toList(),
            entries -&gt; {
                double idf = logDocCount - Math.log(entries.size());
                return entries.stream()
                              .map(e -&gt; tfidfEntry(e, idf))
                              .collect(toList());
            }
        )
    ));

// ((docId, word), count) -&gt; (docId, tfIdf)
private static Entry&lt;Long, Double&gt; tfidfEntry(
        Entry&lt;Entry&lt;Long, String&gt;, Long&gt; tfEntry, Double idf
) {
    final Long tf = tfEntry.getValue();
    return entry(tfEntry.getKey().getKey(), tf * idf);
}
</code></pre>
<p>The search function can be implemented with another Streams expression,
which you can review in the <a href="https://github.com/hazelcast/hazelcast-jet-code-samples/blob/master/batch/tf-idf/src/main/java/SearchGui.java" class="external">SearchGui</a>
class. You can also run the <a href="https://github.com/hazelcast/hazelcast-jet-code-samples/blob/master/batch/tf-idf/src/main/java/TfIdfJdkStreams.java" class="external">TfIdfJdkStreams</a>
class and take the inverted index for a spin, making actual searches.</p>
<p>There is one last concept in this model that we haven't mentioned yet:
the <em>stopword set</em>. It contains those words that are known in advance to
be common enough to occur in every document. Without treatment, these
words are the worst case for the inverted index: the document list under
each such word is the longest possible, and the score of all documents
is zero due to zero IDF. They raise the index's memory footprint without
providing any value. The cure is to prepare a file, <code>stopwords.txt</code>,
which is read in advance into a <code>Set&lt;String&gt;</code> and used to filter out the
words in the tokenization phase. The same set is used to cross out words
from the user's search phrase, as if they weren't entered.</p>
    </div>

        <nav>
        <ul class="Pager">
            <li class=Pager--prev><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/index.html">Previous</a></li>            <li class=Pager--next><a href="../Advanced_Tutorial_-_Inverted_TF-IDF_Index/Translating_to_Jet_DAG.html">Next</a></li>        </ul>
    </nav>
    </article>

            </div>
        </div>
    </div>
</div>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-12653604-10', '');
    ga('send', 'pageview');
</script>

    <!-- jQuery -->
    <script src="../themes/daux/js/jquery-1.11.3.min.js"></script>

    <!-- hightlight.js -->
    <script src="../themes/daux/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- JS -->
    
    <script src="../themes/daux/js/daux.js"></script>

            <!-- Tipue Search -->
        <script type="text/javascript" src="../tipuesearch/tipuesearch.js"></script>

        <script>
            window.onunload = function(){}; // force $(document).ready to be called on back/forward navigation in firefox
            $(function() {
                tipuesearch({
                    'base_url': '../'
                });
            });
        </script>
    
</body>
</html>
